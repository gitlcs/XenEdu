#!/bin/bash
#
# Script de generation du fichier /etc/sudoers pour XenEdu
# D'apres le meme script pour LCS
#
# 01/06/2010 - Simon Cavey - simon.cavey@crdp.ac-caen.fr
# Projet XenEdu

# On sauvegarde le fichier sudo d'origine
if [ ! -e "/etc/sudoers.xenedu-sauve" ]; then
	cp /etc/sudoers /etc/sudoers.xenedu-sauve
fi

# on copie le fichier sudoers d'origine
cp /etc/sudoers /etc/sudoers.in
chmod 700  /etc/sudoers.in

## On nettoy xenedu sudoers des anciennes entrees sudo : 
# nettoyage de sudoers :
sed -i'' '/www-data/d' /etc/sudoers.in
sed -i'' '/xenedu/d' /etc/sudoers.in

# on ajoute les entrees XenEdu
echo "### Sudo-entrees generated by xenedu-make-sudoers  ###"  >> /etc/sudoers.in
for i in /etc/xenedu/sudo.d/* ; do
	echo "### XenEdu-$i : entrees sudo de $i ###"  >> /etc/sudoers.in
	cat $i >> /etc/sudoers.in 
 	echo "###" >> /etc/sudoers.in
done

# On ouvre sudoers en ecriture
chmod 700  /etc/sudoers

# suppresion de doublons et ecriture du fichier sudoers:
# On test si le deuxieme champs est unique
awk '!x[$2]++' /etc/sudoers.in > /etc/sudoers

# On remet les droits sur /etc/sudoers et supprime .in
chmod 440  /etc/sudoers
rm /etc/sudoers.in

# On test le resultat et remet le backup si failed 
visudo -c
if [ "$?" -ne "0" ]; then
	echo "Erreur lors de la gereration du fichier sudo"
	cp /etc/sudoers.xenedu-sauve /etc/sudoers 
	exit 0
fi

